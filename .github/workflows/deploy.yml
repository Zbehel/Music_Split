name: Deploy to Modal & Cloudflare

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Run tests
        run: pytest tests/

  deploy-modal:
    name: Deploy API to Modal
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Modal
        run: pip install modal
      - name: Deploy to Modal (Production)
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          # Modal CLI uses these environment variables automatically
          modal deploy --env prod deploy/modal/modal_app.py
          
  deploy-frontend:
    name: Deploy Frontend to Cloudflare
    runs-on: ubuntu-latest
    needs: deploy-modal
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Build and Deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # You should set this secret in GitHub to your Modal API URL
          VITE_API_URL: ${{ secrets.VITE_API_URL }} 
        run: |
          cd deploy/cloudflare
          # We need to pass VITE_API_URL to the build script
          export API_URL=$VITE_API_URL
          ./deploy.sh
