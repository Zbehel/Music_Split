name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================================
  # Tests rapides sur PR
  # ============================================================
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Pour conventional commits check
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Check code formatting
      run: |
        black --check src/ tests/ || echo "‚ö†Ô∏è  Code needs formatting"
    
    - name: Run fast tests only
      run: |
        pytest tests/ -v -m "not slow" --tb=short
    
    - name: Check conventional commits
      uses: webiny/action-conventional-commits@v1.3.0
      continue-on-error: true

  # ============================================================
  # Analyse de s√©curit√© du code
  # ============================================================
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Bandit security linter
      run: |
        pip install bandit
        bandit -r src/ -f json -o bandit-report.json || true
        cat bandit-report.json
    
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: bandit-report.json

  # ============================================================
  # V√©rification des d√©pendances
  # ============================================================
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for outdated dependencies
      run: |
        pip install pip-audit
        pip-audit -r requirements.txt || true
    
    - name: Check for security vulnerabilities
      uses: pypa/gh-action-pip-audit@v1.0.8
      with:
        inputs: requirements.txt
      continue-on-error: true

  # ============================================================
  # Label automatique bas√© sur les fichiers modifi√©s
  # ============================================================
  auto-label:
    name: Auto Label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
    - name: Label PR based on changed files
      uses: actions/labeler@v5
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        configuration-path: .github/labeler.yml

  # ============================================================
  # Commentaire automatique avec r√©sum√©
  # ============================================================
  pr-comment:
    name: PR Summary Comment
    runs-on: ubuntu-latest
    needs: [quick-checks, security-check, dependency-check]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const tests = '${{ needs.quick-checks.result }}';
          const security = '${{ needs.security-check.result }}';
          const deps = '${{ needs.dependency-check.result }}';
          
          const getEmoji = (status) => {
            if (status === 'success') return '‚úÖ';
            if (status === 'failure') return '‚ùå';
            return '‚ö†Ô∏è';
          };
          
          const body = `## üîç Pull Request Checks Summary
          
          | Check | Status |
          |-------|--------|
          | Tests | ${getEmoji(tests)} ${tests} |
          | Security | ${getEmoji(security)} ${security} |
          | Dependencies | ${getEmoji(deps)} ${deps} |
          
          ${tests !== 'success' ? '‚ö†Ô∏è Please fix failing tests before merging.' : ''}
          ${security !== 'success' ? '‚ö†Ô∏è Security issues detected. Review the security report.' : ''}
          
          ---
          *Automated checks by GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
